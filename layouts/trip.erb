<% render "default" do %>
  <article class="post" id="gallery-container">
    <header>
      <h2><%= @item[:title] %></h2>
      <aside>
        <%= attribute_to_time(@item[:created_at]).strftime("%B %e, %G") %><br />
        <%=  @item[:tags].join(", ") %>
      </aside>
      <%= article_image(@item) %>
    </header>

    <div class="content">
      <%= yield %>
    </div>

    <div class="social">
      <ul>
        <li class="facebook"><div class="fb-share-button" data-href="<%= page_url(@item)  %>" data-layout="button_count"></div></li>
        <li class="twitter"><a href="https://twitter.com/share" class="twitter-share-button" data-via="jakubgarfield" data-hashtags="travel">Tweet</a></li>
      </ul>
    </div>

    <% if @item[:map_coordinates] %>
      <div class="map">
        <div id="map-canvas"></div>
      </div>
    <% end %>

    <% if @item[:gpx]  %>
      <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
      <link rel="stylesheet" href="https://rawgit.com/MrMufflon/Leaflet.Elevation/master/dist/leaflet.elevation-0.0.4.css" />
      <section class="map">
        <article>
          <div id="leaflet-map"></div>
        </article>

        <footer>
          <ul class="info">
            <li>Distance:&nbsp;<span class="distance"></span>&nbsp;km</li>
            &mdash; <li>Moving duration:&nbsp;<span class="duration"></span></li>
            &mdash; <li>Average speed:&nbsp;<span class="average-speed"></span>&nbsp;km/h</li>
            &mdash; <li>Elevation:&nbsp;+<span class="elevation-gain"></span>&nbsp;m, -<span class="elevation-loss"></span>&nbsp;m</li>
          </ul>
        </footer>
      </section>
    <% end %>

    <footer>
      <div class="comments">
        <div id="disqus_thread"></div>
      </div>
    </footer>
  </article>

  <div id="blueimp-gallery" class="blueimp-gallery">
    <div class="slides"></div>
    <h3 class="title"></h3>
    <a class="prev">‹</a>
    <a class="next">›</a>
    <a class="close">×</a>
    <a class="play-pause"></a>
    <ol class="indicator"></ol>
  </div>

  <div id="fb-root"></div>
  <% if @item[:map_coordinates] %>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script>
    function initialize() {
      var map_canvas = document.getElementById("map-canvas");
      if (map_canvas) {
        var map_options = {
          zoom: <%= @item[:map_zoom] ? @item[:map_zoom] : 16 %>,
                <%= @item[:map_coordinates] ? "center: new google.maps.LatLng(#{@item[:map_coordinates]})," : "" %>
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map = new google.maps.Map(map_canvas, map_options);
      }
    }
    google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  <% end %>

  <% if @item[:gpx] %>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
    <script type="text/javascript" src="https://rawgit.com/MrMufflon/Leaflet.Elevation/master/dist/leaflet.elevation-0.0.4.min.js"></script>
    <script type="application/javascript">
      function _t(t) { return document.getElementsByTagName(t)[0]; }
      function _c(c) { return document.getElementsByClassName(c)[0]; }
      function round(number) { return Math.round(number * 100) / 100; }
      function format_duration(seconds) {
        var result = "";
        var hours   = Math.floor(seconds / 3600);
        var minutes = Math.floor((seconds - (hours * 3600)) / 60);

        if (hours == 1) { result += hours + " hour"; }
        else if (hours > 0) { result += hours + " hours";}

        if (hours > 0 && minutes > 0) { result += " and "; }

        if (minutes == 1) { result += hours + " minute"; }
        if (minutes > 0) {result += minutes + " minutes"; }

        return result;
      }

      var map = new L.Map('leaflet-map');
      var url = 'http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpeg';
      var attribution = '<a href="http://www.mapquest.com/">MapQuest</a> &mdash; Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors</a>';
      var tileLayer = new L.TileLayer(url, {subdomains:"1234",attribution: attribution});

      var geojson = <%= generate_geojson(@item) %>;
      var elevation = L.control.elevation({
        position: "topright",
        theme: "steelblue-theme",
        width: 600,
        height: 125,
        margins: { top: 10, right: 20, bottom: 30, left: 50 },
        useHeightIndicator: true,
        interpolation: "linear",
        hoverNumber: {
            decimalsX: 3,
            decimalsY: 0,
            formatter: undefined
        },
        xTicks: undefined,
        yTicks: undefined,
        collapsed: false
      });
      elevation.addTo(map);

      var gjl = L.geoJson(geojson,{ onEachFeature: function(feature, layer) { elevation.addData.bind(elevation)(feature, layer); } }).addTo(map);
      map.addLayer(tileLayer).fitBounds(gjl.getBounds());

      _c('distance').textContent = round(geojson.properties.distance / 1000);
      _c('duration').textContent = format_duration(geojson.properties.moving_duration);
      _c('average-speed').textContent = round(geojson.properties.average_moving_speed);
      _c('elevation-gain').textContent = round(geojson.properties.uphill_elevation);
      _c('elevation-loss').textContent = -1 * round(geojson.properties.downhill_elevation);
    </script>
  <% end %>
  <script type="text/javascript"> var disqus_shortname = 'kiwischodounskynet'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <script>
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
    (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.3&appId=1478320385777176"; fjs.parentNode.insertBefore(js, fjs); }(document, 'script', 'facebook-jssdk'));
  </script>
<% end %>
